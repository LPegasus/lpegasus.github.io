<!doctype html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-alpha.72">
<link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="React Tutorial Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="React Tutorial Blog Atom Feed"><title data-react-helmet="true">V8 引擎中的可视化内存管理 | React Tutorial</title><meta data-react-helmet="true" property="og:url" content="https://lpegasus.github.io/docs/js/memory-management-in-v8"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_version" content="current"><meta data-react-helmet="true" name="docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="V8 引擎中的可视化内存管理 | React Tutorial"><meta data-react-helmet="true" name="description" content="原文地址：https://deepu.tech/memory-management-in-v8/"><meta data-react-helmet="true" property="og:description" content="原文地址：https://deepu.tech/memory-management-in-v8/"><link data-react-helmet="true" rel="shortcut icon" href="/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://lpegasus.github.io/docs/js/memory-management-in-v8"><link data-react-helmet="true" rel="alternate" href="https://lpegasus.github.io/docs/js/memory-management-in-v8" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://lpegasus.github.io/docs/js/memory-management-in-v8" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.8c6c7953.css">
<link rel="preload" href="/assets/js/styles.6be99364.js" as="script">
<link rel="preload" href="/assets/js/runtime~main.3794155c.js" as="script">
<link rel="preload" href="/assets/js/main.894f7e73.js" as="script">
<link rel="preload" href="/assets/js/1.c393ad28.js" as="script">
<link rel="preload" href="/assets/js/2.c9746026.js" as="script">
<link rel="preload" href="/assets/js/3.48c633b2.js" as="script">
<link rel="preload" href="/assets/js/1be78505.c376574c.js" as="script">
<link rel="preload" href="/assets/js/20.657c082f.js" as="script">
<link rel="preload" href="/assets/js/935f2afb.b09dafbb.js" as="script">
<link rel="preload" href="/assets/js/17896441.bf15119d.js" as="script">
<link rel="preload" href="/assets/js/94a63f74.65f060ed.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><a href="#main" class="skipToContent_2Z82">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle" type="button" tabindex="0"><svg aria-label="Menu" width="30" height="30" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><img src="/img/bytedance.png" alt="ByteDance Logo" class="themedImage_3nrA themedImage--light_fdaD navbar__logo"><img src="/img/bytedance.png" alt="ByteDance Logo" class="themedImage_3nrA themedImage--dark_QH-a navbar__logo"></a><a class="navbar__item navbar__link" href="/docs/getting-started">Docs</a><a class="navbar__item navbar__link" href="/docs/hooks/summary">Hooks</a><a class="navbar__item navbar__link" href="/docs/js/index">JS</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/LPegasus/tutorial-bytedance-fe" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub</a><div class="react-toggle react-toggle--disabled displayOnlyInLargeViewport_1T7Q"><div class="react-toggle-track"><div class="react-toggle-track-check"><span class="toggle_1Hkd">🌜</span></div><div class="react-toggle-track-x"><span class="toggle_1Hkd">🌞</span></div></div><div class="react-toggle-thumb"></div><input type="checkbox" disabled="" aria-label="Dark mode toggle" class="react-toggle-screenreader-only"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a class="navbar__brand" href="/"><img src="/img/bytedance.png" alt="ByteDance Logo" class="themedImage_3nrA themedImage--light_fdaD navbar__logo"><img src="/img/bytedance.png" alt="ByteDance Logo" class="themedImage_3nrA themedImage--dark_QH-a navbar__logo"></a></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/docs/getting-started">Docs</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/hooks/summary">Hooks</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/js/index">JS</a></li><li class="menu__list-item"><a href="https://github.com/LPegasus/tutorial-bytedance-fe" target="_blank" rel="noopener noreferrer" class="menu__link">GitHub</a></li></ul></div></div></div></nav><div class="main-wrapper main-docs-wrapper"><div class="docPage_3JYt"><main class="docMainContainer_3daS"><div class="container padding-vert--lg docItemWrapper_211s"><div class="row"><div class="col docItemCol_ReEH"><div class="docItemContainer_2CRG"><article><header><h1 class="docTitle_1jbz">V8 引擎中的可视化内存管理</h1></header><div class="markdown"><blockquote><p>原文地址：<a href="https://deepu.tech/memory-management-in-v8/" target="_blank" rel="noopener noreferrer">https://deepu.tech/memory-management-in-v8/</a>
原文作者：Deepu K Sasidharan
译：张馨中 - 字节跳动大力智能前端团队</p></blockquote><p>在这由多部分组成的系列文章中，我旨在揭露内存管理背后的概念，并更深入地研究某些现代编程语言中的内存管理。 我希望该系列文章可以使你对这些语言的内存管理机制下所发生的事有所了解。</p><p>在本章中，我们将研究 <em>V8</em> 引擎对 <em>ECMAScript</em> 和 <em>WebAssembly</em> 中的内存管理。该内存管理广泛应用于 <em>NodeJS</em>、<em>Deno</em> 和 <em>Electron</em> 等运行时以及 <em>Chrome</em>、<em>Chromium</em>、<em>Brave</em>、<em>Opera</em> 和 <em>Microsoft Edge</em> 等 <em>Web</em> 浏览器中。由于 <em>JavaScript</em> 是一种解释型语言，它需要一个引擎来解释和执行代码。<em>V8</em> 引擎解释 <em>JavaScript</em> 并将其编译为机器码。<em>V8</em> 是用 <em>C++</em> 编写的，可以嵌入任何 <em>C++</em> 应用程序中。</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_3uMs" id="v8-的内存结构"></a>V8 的内存结构<a class="hash-link" href="#v8-的内存结构" title="Direct link to heading">#</a></h2><p>首先，我们来看看 <em>V8</em> 引擎的内存结构。因为 <em>JS</em> 是单线程 <em>V8</em> 也为每个 <em>JS</em> 上下文建立了一个单独的进程。并且如果你使用了 <em>service worker</em>，它会为每个 <em>worker</em> 建立一个新的 <em>V8</em> 进程。一个正在运行的程序总是由一些分配好的、被称为常驻集的内存来表示。常驻集内存可进一步划分为以下多个部分：</p><div style="max-width:600px"><img src="/img/v8-memory-struct.png" alt=""></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_3uMs" id="堆内存（heap-memory）"></a>堆内存（Heap Memory）<a class="hash-link" href="#堆内存（heap-memory）" title="Direct link to heading">#</a></h3><p>这是 <em>V8</em> 存储对象和动态数据的地方。这是最大的内存块，也是垃圾回收（GC）发生的地方。垃圾回收不管理整个堆内存，只管理新旧空间。堆可被进一步划分为以下区域：</p><ul><li><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_3uMs" id="新空间新生代空间"></a>新空间/新生代空间<a class="hash-link" href="#新空间新生代空间" title="Direct link to heading">#</a></h4><p>新空间或“新生代空间”是新的对象所在的位置，并且其中大多数对象的生命周期都较短。这个空间非常小并且拥有两个半空间，类似于 <em>JVM</em> 中的 <em>S0</em> 和 <em>S1</em>。这个空间由 <code>Scavenger（Minor GC）</code> 管理（我们会在之后的内容中介绍 <code>Minor GC</code>）。新生代空间的大小可以通过使用
<code>--min_semi_space_size</code>（初始） 和 <code>--max_semi_space_size</code>（最大） <em>V8</em> 参数控制。</p></li><li><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_3uMs" id="旧空间老生代空间"></a>旧空间/老生代空间<a class="hash-link" href="#旧空间老生代空间" title="Direct link to heading">#</a></h4><p>旧空间或者“老年代空间”是新生代空间中经历了两轮垃圾回收仍存活的对象被移动到的地方。这个空间被 <code>Major GC（Mark-Sweep &amp; Mark-Compact）</code> 管理（我们会在之后的内容中介绍 <code>Major GC</code>）。老年代空间的大小可以被 <em>V8</em> 的 <code>--initial_old_space_size</code>（初始） 和 <code>--max_old_space_size</code>（最大） 两个参数控制。这个空间被分成了两部分：</p><ul><li><strong>旧指针空间</strong>：包含了具有指向其他对象的指针的幸存对象。</li><li><strong>旧数据空间</strong>：包含了只具有数据的对象（不具有指向其他对象的指针）。字符串、包装数字和基础双精度数组在新生代空间存活过两次垃圾回收后，都会被移入这个空间</li></ul></li><li><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_3uMs" id="大对象空间"></a>大对象空间<a class="hash-link" href="#大对象空间" title="Direct link to heading">#</a></h4><p>这是大于其他空间大小限制的对象所在的位置。每个对象都会有自己内存中的的 <a href="https://en.wikipedia.org/wiki/Mmap" target="_blank" rel="noopener noreferrer"><em>mmap</em></a> 区域。大对象永远不会被垃圾回收移除。</p></li><li><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_3uMs" id="代码空间"></a>代码空间<a class="hash-link" href="#代码空间" title="Direct link to heading">#</a></h4><p>这是即时编译器 <code>Just-in-time（JIT）</code> <em>Compiler</em> 存储编译过的代码块的地方。这是唯一具有可执行内存的空间（尽管代码可以在“大对象空间”中分配，而且这些代码也可执行）。</p></li><li><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_3uMs" id="cell-空间、propertycell-空间和-map-空间"></a><em>Cell</em> 空间、<em>PropertyCell</em> 空间和 <em>Map</em> 空间<a class="hash-link" href="#cell-空间、propertycell-空间和-map-空间" title="Direct link to heading">#</a></h4><p>这些空间分别包含 <em>Cells</em> 、<em>PropertyCells</em> 和 <em>Maps</em>。每个空间都包含大小相同的对象，并且对它们指向的对象类型有一些限制，从而简化了收集。</p></li></ul><p>每个空间都由一组页组成。页是操作系统根据 <a href="https://en.wikipedia.org/wiki/Mmap" target="_blank" rel="noopener noreferrer"><em>mmap</em></a>（或者 <em>Windows</em> 中的 <em>MapViewOfFile</em>） 分配的连续内存块。每个页都是 1MB 大小，除了大对象空间。</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_3uMs" id="栈（stack）"></a>栈（Stack）<a class="hash-link" href="#栈（stack）" title="Direct link to heading">#</a></h3><p>本节讲述栈内存区域，每个 <em>V8</em> 进程有一个栈。这是静态数据（包括方法/函数框架、基本类型值和指向对象的指针）的存储位置。堆栈大小可以使用 <em>V8</em> 参数 <code>--stack_size</code> 设置。</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_3uMs" id="v8-内存使用-（栈-vs-堆）"></a>V8 内存使用 （栈 vs 堆）<a class="hash-link" href="#v8-内存使用-（栈-vs-堆）" title="Direct link to heading">#</a></h2><p>既然我们已经了解了内存是如何组织的，那么让我们看看在执行程序时内存中最重要的部分是如何使用的。</p><p>让我们使用下面的 <em>JavaScript</em> 程序，代码没有针对正确性进行优化，因此忽略不必要的中间变量等问题，重点是可视化栈和堆内存使用情况。</p><div class="codeBlockContainer_2lFU"><div class="codeBlockContent_w8-F js"><div tabindex="0" class="prism-code language-js codeBlock_1fKq thin-scrollbar"><div class="codeBlockLines_NP6K" style="color:#9CDCFE;background-color:#1E1E1E"><div class="token-line" style="color:#9CDCFE"><span class="token keyword" style="color:rgb(86, 156, 214)">class</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(78, 201, 176)">Employee</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token function" style="color:rgb(220, 220, 170)">constructor</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token parameter">name</span><span class="token parameter punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token parameter"> salary</span><span class="token parameter punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token parameter"> sales</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">this</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token property-access">name</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> name</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">this</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token property-access">salary</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> salary</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">this</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token property-access">sales</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> sales</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">const</span><span class="token plain"> </span><span class="token constant" style="color:rgb(100, 102, 149)">BONUS_PERCENTAGE</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">10</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">function</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">getBonusPercentage</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token parameter">salary</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token keyword" style="color:rgb(86, 156, 214)">const</span><span class="token plain"> percentage </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">salary </span><span class="token operator" style="color:rgb(212, 212, 212)">*</span><span class="token plain"> </span><span class="token constant" style="color:rgb(100, 102, 149)">BONUS</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">*</span><span class="token plain"> </span><span class="token constant" style="color:rgb(100, 102, 149)">PERCENTAGE</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">/</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">100</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token keyword control-flow" style="color:rgb(86, 156, 214)">return</span><span class="token plain"> percentage</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">function</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">findEmployeeBonus</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token parameter">salary</span><span class="token parameter punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token parameter"> noOfSales</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token keyword" style="color:rgb(86, 156, 214)">const</span><span class="token plain"> bonusPercentage </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">getBonusPercentage</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">salary</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token keyword" style="color:rgb(86, 156, 214)">const</span><span class="token plain"> bonus </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> bonusPercentage </span><span class="token operator" style="color:rgb(212, 212, 212)">*</span><span class="token plain"> noOfSales</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token keyword control-flow" style="color:rgb(86, 156, 214)">return</span><span class="token plain"> bonus</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">let</span><span class="token plain"> john </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">new</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(78, 201, 176)">Employee</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;John&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">5000</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">5</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain">john</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token property-access">bonus</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">findEmployeeBonus</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">john</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token property-access">salary</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> john</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token property-access">sales</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token console class-name" style="color:rgb(78, 201, 176)">console</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token method function property-access" style="color:rgb(220, 220, 170)">log</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">john</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token property-access">bonus</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_1Z0Y">Copy</button></div></div><p>单击幻灯片并使用箭头键向前/向后移动，以查看上述程序的执行方式以及堆栈和堆内存的使用方式：</p><iframe width="730px" height="411px" sandbox="allow-scripts allow-same-origin allow-popups allow-presentation allow-forms" frameborder="0" allowfullscreen="" allow="encrypted-media;" src="https://speakerdeck.com/player/e89e2e48a797417eb8692897dcada584"></iframe><blockquote><p>注意：如果幻灯片的边缘看起来被切断，请单击幻灯片的标题或此处直接在 <a href="https://speakerdeck.com/deepu105/v8-minor-gc" target="_blank" rel="noopener noreferrer">SpeakerDeck</a> 中打开它。</p></blockquote><p>你可以看到：</p><ol><li>全局作用于在栈中的全局 <em>frame</em> 保存</li><li>每个函数调用都会作为一个 <em>frame-block</em> 被加到栈内存中</li><li>所有的局部变量包括参数和返回值都被保存在栈中函数的 <em>frame-block</em> 里</li><li>所有的基础类型比如 <em>int</em> 和 <em>string</em> 都被直接保存在栈中。这同样适用于全局作用域，也因此 <em>String</em> 在 <em>JS</em> 中是基础类型</li><li>所有的对象类型比如 <em>Employee</em> 和 <em>Function</em> 都在堆中创建并且栈中通过栈指针持有引用。<em>Functions</em> 在 <em>JS</em> 中就是对象。这也适用于全局作用域</li><li>当前函数调用的函数在栈的顶部入栈</li><li>当一个函数运行完毕时，它的 <em>frame</em> 从栈中移除</li><li>一旦主进程完成，栈中就不再有指向堆上的对象的指针，从而堆上对应的对象就变成“孤儿”</li><li>除非显式复制，否则其他对象中的所有对象引用都是使用引用指针完成的</li></ol><p>如你所见，栈由操作系统自动管理的，而不是 <em>V8</em> 本身。因此，我们不必太担心栈。另一方面，堆不是由操作系统自动管理的，因为它拥有最大的内存空间并保存动态数据，它可能会以指数级增长，导致我们的程序随着时间的推移耗尽内存。随着时间的推移，它也会变得分散，减慢应用程序的速度。这就是垃圾收集的用武之地。</p><p>区分堆上的指针和数据对于垃圾收集很重要，<em>V8</em> 为此使用“标记指针”方法 —— 在这种方法中，它在每个字的末尾保留一个位，以指示它是指针还是数据。这种方法需要有限的编译器支持，但实现起来很简单，同时相当高效。</p><p><em>V8</em> 内存管理: 垃圾收集
既然我们知道了 <em>V8</em> 如何分配内存，那么让我们看看它是如何自动管理堆内存的，这对应用程序的性能非常重要。当程序试图在堆上分配比可用内存更多的内存（取决于 <em>V8</em> 标志集），我们会遇到内存不足错误。管理不当的堆也可能导致内存泄漏。</p><p><em>V8</em> 通过垃圾回收来管理堆内存。简单地说，它释放孤儿对象 —— 栈不再直接或间接（通过另一个对象中的引用）持有引用的对象 —— 使用的内存，为创建新对象腾出空间。</p><blockquote><p><em>Orinoco</em> 是 <em>V8</em> 的 <em>GC</em> 项目代号，它利用并行、增量和并发技术进行垃圾收集，以减轻主线程负担。</p></blockquote><p><em>V8</em> 中的垃圾收集器负责回收未使用的内存，供 <em>V8</em> 进程重用。</p><p><em>V8</em> 垃圾收集器是分代的（堆中的对象按其年龄分组，并在不同阶段清除）。<em>V8</em> 的垃圾收集有两个阶段和三种不同的算法：</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_3uMs" id="minor-gc-（scavenger）"></a>Minor GC （Scavenger）<a class="hash-link" href="#minor-gc-（scavenger）" title="Direct link to heading">#</a></h3><p>这种类型的垃圾收集保持新生代的空间紧凑和清洁。对象被分配到新生代空间中，这个空间相当小（根据行为启发，在 1 到 8 MB 之间）。“新空间”中的分配非常便宜：有一个分配指针，每当我们想为一个新对象保留空间时，这个指针就会递增。当分配指针到达新空间的末尾时，将触发 <code>Minor GC</code>。这个过程也被称为清道夫，它使用了<a href="https://en.wikipedia.org/wiki/Cheney&#x27;s_algorithm" target="_blank" rel="noopener noreferrer">切尼算法</a>。<code>Minor GC</code> 触发频繁，使用并行的 <em>helper</em> 线程使得速度很快。</p><p>让我们看看 <code>Minor GC</code> 的过程：</p><p>新空间被分成两个大小相等的半空间：<code>to-space</code> 和 <code>from-space</code>。大多数分配都是从 <code>from-space</code> 进行的（除了某些类型的对象，例如总是在旧空间中分配的可执行代码）。当 <code>from-space</code> 填满时，将触发 <code>Minor GC</code>。</p><p>单击幻灯片并使用箭头键向前/向后移动以查看过程：</p><iframe width="730px" height="411px" sandbox="allow-scripts allow-same-origin allow-popups allow-presentation allow-forms" frameborder="0" allowfullscreen="" allow="encrypted-media;" src="https://speakerdeck.com/player/5fff2548e55c4bb0a9c837c7eb598bee"></iframe><blockquote><p>注意：如果幻灯片的边缘看起来被切断，请单击幻灯片的标题或此处直接在 <a href="https://speakerdeck.com/deepu105/v8-minor-gc" target="_blank" rel="noopener noreferrer">SpeakerDeck</a> 中打开它。</p></blockquote><p>你可以看到：</p><ol><li>让我们假设，当我们开始时，<code>from-space</code> 上已经有对象（块 01 到 06 标记为已用内存）。</li><li>进程创建了一个新对象（07）。</li><li><em>V8</em> 试图从空间中获取所需的内存，但是那里没有空闲空间来容纳我们的对象，因此 <em>V8</em> 触发了 <code>Minor GC</code>。</li><li><code>Minor GC</code> 从栈指针（<em>GC</em> 根）开始递归地遍历 <code>from-space</code> 中的对象图，以查找已使用或活动的对象（已用内存）。这些对象将移动到 <code>to-space</code> 中的页。这些对象引用的任何对象也会被移动到 <code>to-space</code> 中的该页，并且它们的指针也会更新。重复这个过程，直到 <code>from-space</code> 中的所有对象都被扫描。最后，<code>to-space</code> 被自动压缩。</li><li><code>Minor GC</code> 现在清空 <code>from-space</code>，因为这里剩余的任何对象都是垃圾</li><li><code>Minor GC</code> 交换 <code>to-space</code> 和 <code>from-space</code>，所有对象现在都在 <code>from-space</code> 中，<code>to-space</code> 为空</li><li>新对象在 <code>from-space</code> 中分配内存</li><li>让我们假设一段时间过去了，<code>from space</code> 上现在有更多的对象（块 07 到 09 标记为已用内存）</li><li>应用程序创建一个新对象（10）</li><li><em>V8</em> 试图从 <code>from-space</code> 获取所需的内存，但那里没有可用空间来容纳我们的对象，因此 <em>V8</em> 触发了第二次 <code>Minor GC</code></li><li>重复上述过程，并将第二个 <code>Minor GC</code> 后幸存的所有活动对象移动到“旧空间”。第一次幸存者被转移到 <code>to-space</code>，剩余的垃圾从 <code>from-space</code> 中清除</li><li><code>Minor GC</code> 交换 <code>to-space</code> 和 <code>from-space</code>，所有对象现在都在 <code>from-space</code> 中，<code>to-space</code> 为空</li><li>新对象在 <code>from-space</code> 中分配内存</li></ol><p>所以我们看到了 <code>Minor GC</code> 是如何从新生代回收空间并使其保持紧凑。这是一个 <code>stop-the-world</code> 的过程，但它是如此快速和高效，以至于在大部分情况下是微不足道的。因为这个过程不会扫描“旧空间”中的对象是否有“新空间”中对象的引用，所以使用专门的寄存器存储从旧空间到新空间的所有指针。这是通过一个称为写屏障的过程记录到存储缓冲区中的。</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_3uMs" id="major-gc"></a>Major GC<a class="hash-link" href="#major-gc" title="Direct link to heading">#</a></h3><p>这种 <em>GC</em> 保持了老年代空间的紧凑和干净。老年代空间会在 <code>Minor GC</code> 的循环中被填满，当 <em>V8</em> 根据动态计算得到限制判断没有足够的旧空间时，就会触发 <code>Major GC</code>。</p><p><code>Scavenger</code> 算法对于小数据量是完美的，但对于大堆（如旧空间）则不实际，因为它有内存开销，因此 <code>Major GC</code> 是使用 <em>Mark-Sweep Compact</em> 算法完成的。它使用三色（白灰黑）标记系统。因此，<code>Major GC</code> 是一个三步过程，第三步根据分段启发式执行。</p><ol><li><strong>标记</strong>：两种算法都很常规的第一步，其中垃圾收集器标识哪些对象正在使用，哪些对象不在使用。正在使用或可从 <em>GC</em> 根（堆栈指针）递归访问的对象被标记为活动的。从技术上讲，可以把堆的深度看作是一个图。</li><li><strong>清理</strong>：垃圾回收器遍历堆并记录任何未标记为活动的对象的内存地址。这个空间现在在空闲列表中标记为空闲，可以用来存储其他对象。</li><li><strong>压缩</strong>：清扫后，如有需要，将所有幸存物体移到一起。这将减少碎片并提高向新对象分配内存的性能。</li></ol><p>这种类型的 <em>GC</em> 也称为 <em>Stop-the-world GC</em>，因为它们在执行 <em>GC</em> 的过程中会引入暂停时间。 为了避免这种情况，<em>V8</em> 使用如下的技术：</p><ul><li><strong>增量式 <em>GC</em></strong>：<em>GC</em> 是以多个增量步骤而不是一个增量步骤完成的。</li><li><strong>并发标记</strong>：标记是使用多个 <em>helper</em> 线程并发完成的，而不会影响主 <em>JavaScript</em> 线程。 当 <em>helper</em> 线程在进行并发标记时，写屏障用于跟踪记录 <em>JavaScript</em> 创建的对象之间的新引用。</li><li><strong>并发清除/压缩</strong>：清除和压缩在 <em>helper</em> 线程中同时进行，而不影响主 <em>JavaScript</em> 线程。</li><li><strong>懒散的扫荡</strong>： 懒惰扫描涉及延迟页中垃圾的删除，直到需要内存为止。</li></ul><p>让我们看一下 <code>Major GC</code> 的流程：</p><ol><li>让我们假设已经经过了许多 <code>Minor GC</code> 周期、旧空间几乎已满，并且 <em>V8</em> 决定触发 <code>Major GC</code>。</li><li><code>Major GC</code> 从堆栈指针开始递归地遍历对象图，以标记在旧空间中的存活对象（已用内存）和剩余的垃圾对象（孤儿对象）。 这是使用多个并发的 <em>helper</em> 线程完成的，每个 <em>helper</em> 线程都跟随一个指针。 这不会影响 <em>JS</em> 主线程。</li><li>完成并发标记或达到内存限制后，<em>GC</em> 将使用主线程执行标记完成步骤。 这会引入少量的暂停时间。</li><li>现在，<code>Major GC</code> 使用并发扫描线程将所有孤儿对象的内存标记为空闲。并行压缩任务也会被触发，以将相关的内存块移至同一页以避免碎片。 这些步骤中也会更新指针。</li></ol><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_3uMs" id="总结"></a>总结<a class="hash-link" href="#总结" title="Direct link to heading">#</a></h2><p>这篇文章应该给您 <em>V8</em> 内存结构和内存管理的概述。 这并不详尽，还有很多更高级的概念，您可以从 <a href="https://v8.dev" target="_blank" rel="noopener noreferrer">v8.dev</a> 中了解它们。但是对于大多数 <em>JS / WebAssembly</em> 开发人员来说，这一级的信息就足够了，我希望它能帮助您编写出更好的代码，对于性能更高的应用程序考虑到这些。记住这些内容也可能会有助于避免下一次的内存泄漏。</p><p>我希望您在学习 <em>V8</em> 的内部结构方面有乐趣，请继续关注本系列的下一篇文章。</p></div></article><div class="margin-vert--xl"><div class="row"><div class="col"><a href="https://github.com/LPegasus/tutorial-bytedance-fe/docs/js/memory-management-in-v8.md" target="_blank" rel="noreferrer noopener"><svg fill="currentColor" height="1.2em" width="1.2em" preserveAspectRatio="xMidYMid meet" role="img" viewBox="0 0 40 40" class="iconEdit_22vn" aria-label="Edit page"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div></div></div><div class="margin-vert--lg"><nav class="pagination-nav" aria-label="Docs pages navigation"><div class="pagination-nav__item"></div><div class="pagination-nav__item pagination-nav__item--next"></div></nav></div></div></div><div class="col col--3"><div class="tableOfContents_c7_T thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#v8-的内存结构" class="table-of-contents__link">V8 的内存结构</a><ul><li><a href="#堆内存（heap-memory）" class="table-of-contents__link">堆内存（Heap Memory）</a></li><li><a href="#栈（stack）" class="table-of-contents__link">栈（Stack）</a></li></ul></li><li><a href="#v8-内存使用-（栈-vs-堆）" class="table-of-contents__link">V8 内存使用 （栈 vs 堆）</a><ul><li><a href="#minor-gc-（scavenger）" class="table-of-contents__link">Minor GC （Scavenger）</a></li><li><a href="#major-gc" class="table-of-contents__link">Major GC</a></li></ul></li><li><a href="#总结" class="table-of-contents__link">总结</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><h4 class="footer__title">Docs</h4><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/docs/getting-started">Getting Started</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">Community</h4><ul class="footer__items"><li class="footer__item"><a href="https://stackoverflow.com/questions/tagged/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Stack Overflow</a></li><li class="footer__item"><a href="https://discordapp.com/invite/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discord</a></li><li class="footer__item"><a href="https://twitter.com/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">More</h4><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/hooks">Hooks</a></li><li class="footer__item"><a href="https://github.com/LPegasus/tutorial-bytedance-fe" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub</a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2021 My Project, Inc. Built with Docusaurus.</div></div></div></footer></div>
<script src="/assets/js/styles.6be99364.js"></script>
<script src="/assets/js/runtime~main.3794155c.js"></script>
<script src="/assets/js/main.894f7e73.js"></script>
<script src="/assets/js/1.c393ad28.js"></script>
<script src="/assets/js/2.c9746026.js"></script>
<script src="/assets/js/3.48c633b2.js"></script>
<script src="/assets/js/1be78505.c376574c.js"></script>
<script src="/assets/js/20.657c082f.js"></script>
<script src="/assets/js/935f2afb.b09dafbb.js"></script>
<script src="/assets/js/17896441.bf15119d.js"></script>
<script src="/assets/js/94a63f74.65f060ed.js"></script>
</body>
</html>